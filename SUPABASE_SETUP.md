# Supabase（Edge Function）セットアップ手順（支出管理 予実）

## 1. Supabaseプロジェクト作成
- 新規プロジェクトを作成
- Project URL を控える（例: `https://xxxx.supabase.co`）

## 2. テーブル作成（SQL Editorで実行）
```sql
create table if not exists shops (
  id bigint generated by default as identity primary key,
  date date not null,
  name text not null,
  created_at timestamptz default now()
);

create table if not exists items (
  id bigint generated by default as identity primary key,
  shop_id bigint not null references shops(id) on delete cascade,
  name text not null,
  planned_price numeric default 0,
  actual_price numeric default 0,
  is_bought boolean default false,
  payment_method text not null default 'LIFE',
  created_at timestamptz default now()
);

-- Monthly budget
create table if not exists budgets (
  id bigint generated by default as identity primary key,
  ym text not null unique, -- 'YYYY-MM'
  amount numeric not null default 0,
  created_at timestamptz default now()
);

create index if not exists shops_date_idx on shops(date);
create index if not exists items_shop_id_idx on items(shop_id);
create index if not exists budgets_ym_idx on budgets(ym);
```

## 3. Edge Function をデプロイ
このリポジトリ直下の `supabase/functions/shopping/` が対象です。

Supabase CLI を使う場合：
- `supabase login`
- `supabase link --project-ref <PROJECT_REF>`
- `supabase functions deploy shopping`

### Edge Function 環境変数（Supabase Dashboard → Functions → Secrets）
- `SHOPPING_TOKEN` … 共有トークン（任意のランダム文字列）
- `SUPABASE_URL` … Project URL
- `SUPABASE_SERVICE_ROLE_KEY` … Service role key（"Project Settings → API"）

※ `SUPABASE_SERVICE_ROLE_KEY` は絶対にブラウザ側へ出さない。

## 4. GitHub Pages（UI）に反映
`index.html` の以下を設定：
- `window.API_BASE = "https://<PROJECT_REF>.functions.supabase.co/functions/v1/shopping"` ではなく、通常は
  `https://<PROJECT_ID>.supabase.co/functions/v1/shopping` を使います（Project URLに続ける）
- `window.API_TOKEN = "<SHOPPING_TOKEN>"`

例：
```js
window.API_BASE = "https://xxxx.supabase.co/functions/v1/shopping";
window.API_TOKEN = "...";
```

## 5. 動作確認
- Pages: https://kim777fk-max.github.io/shopping-webapp/
- 画面から店/商品追加、チェック、実費変更が反映される。
